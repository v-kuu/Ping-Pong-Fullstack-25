---
import Header from "@/islands/Header.tsx";
import "@/astro/styles.css";

interface Props {
  title: string;
  active: string;
  favicon: string;
  class?: string;
}

const { title, active, favicon, class: className } = Astro.props;
const user = Astro.locals.user ?? null;
---

<html lang="en" data-theme="synthwave" class="h-full overflow-hidden">
  <head>
    <script is:inline>
      const savedTheme = localStorage.getItem("theme");
      const theme = savedTheme === "dracula" ? "dracula" : "synthwave";
      document.documentElement.setAttribute("data-theme", theme);
    </script>
    <meta charset="UTF-8" />
    <link rel="preload" href="/logo.svg" as="image" />
    <link rel="preload" href="/web.svg" as="image" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" href={favicon} />
    <title>{title}</title>
    <style>
      .game-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 100;
        transform: translateY(-100%);
        transition: transform 0.3s ease-in-out;
      }
      .game-header.visible {
        transform: translateY(0);
      }
      .game-canvas-wrapper {
        position: fixed;
        inset: 0;
        z-index: 1;
        transition: filter 0.3s ease-in-out;
      }
      .game-canvas-wrapper.blurred {
        filter: blur(8px) brightness(0.7);
        pointer-events: none;
      }
      .pause-hint {
        position: fixed;
        bottom: 1rem;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
        pointer-events: none;
        z-index: 101;
      }
      .pause-hint.visible {
        opacity: 1;
      }
      /* Hide on desktop, show on touch devices */
      @media (hover: hover) and (pointer: fine) {
        .menu-toggle {
          display: none;
        }
        .hint-mobile {
          display: none;
        }
      }
      @media (hover: none) or (pointer: coarse) {
        .hint-desktop {
          display: none;
        }
      }
    </style>
  </head>
  <body class="h-full m-0 overflow-hidden">
    <div class="game-header" id="game-header">
      <Header active={active} user={user} client:load />
    </div>
    <main class={`game-canvas-wrapper ${className ?? ""}`} id="game-canvas">
      <slot />
    </main>
    <button
      class="menu-toggle fixed bottom-3 right-3 z-102 w-10 h-10 rounded-lg bg-black/40 backdrop-blur border border-white/10 text-white text-xl cursor-pointer flex items-center justify-center transition-all hover:bg-black/60 active:scale-95"
      id="menu-toggle"
      aria-label="Toggle menu"
    >☰</button>
    <div class="pause-hint" id="pause-hint">
      <span class="badge badge-lg badge-ghost hint-desktop">Press ESC to resume</span>
      <span class="badge badge-lg badge-ghost hint-mobile">Tap ✕ to resume</span>
    </div>
    <script is:inline>
      (function() {
        const header = document.getElementById('game-header');
        const canvas = document.getElementById('game-canvas');
        const hint = document.getElementById('pause-hint');
        const menuBtn = document.getElementById('menu-toggle');
        let isPaused = false;

        function togglePause() {
          isPaused = !isPaused;
          header.classList.toggle('visible', isPaused);
          canvas.classList.toggle('blurred', isPaused);
          hint.classList.toggle('visible', isPaused);
          menuBtn.textContent = isPaused ? '✕' : '☰';
          document.dispatchEvent(new CustomEvent('gamepause', { detail: isPaused }));
        }

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') togglePause();
        });
        menuBtn.addEventListener('click', togglePause);
      })();
    </script>
  </body>
</html>
