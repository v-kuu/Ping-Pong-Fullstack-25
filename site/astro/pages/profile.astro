---
import Base from "@/astro/layouts/Base.astro";
import { ProfileMenu } from "@/islands/Profile.tsx";
import { db, Matches, Users, eq, or, sql, inArray } from "astro:db";
import { processMatchData, getPlayerIdsFromMatches } from "@/utils/site/matchHelpers";

const user = Astro.locals.user;
if (!user) {
  return Astro.redirect("/login");
}

const userId = user.id;

let matches = [];

try {
  const allMatches = await db
    .select()
    .from(Matches)
    .limit(100);

  const userMatches = allMatches.filter((match) => {
    const playerIds = Array.isArray(match.playerIds) ? match.playerIds : [];
    return playerIds.includes(userId);
  });

  const playerIds = getPlayerIdsFromMatches(userMatches);

  const allPlayers = playerIds.length > 0
    ? await db.select().from(Users).where(inArray(Users.id, playerIds))
    : [];

  matches = processMatchData(userMatches, userId, allPlayers);
} catch (error) {
  console.error("Failed to load profile data:", error);
  return Astro.redirect("/500");
}
---

<Base title="Profile" active="/profile" favicon="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âœ¨</text></svg>">
  <ProfileMenu user={user} matches={matches} client:load />
</Base>
